
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>ReadLightToolsSpectrumFile</title><meta name="generator" content="MATLAB 9.10"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2022-02-12"><meta name="DC.source" content="ReadLightToolsSpectrumFile.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>ReadLightToolsSpectrumFile</h1><!--introduction--><p>
 <p style="font-size:75%;">Navigate to: &nbsp;
<a href="JMOSpectrumLibrary.html"> Home</a> &nbsp; | &nbsp;
<a href="AlphabeticList.html"> Alphabetic list</a> &nbsp; | &nbsp;
<a href="GroupedList.html"> Grouped list</a> &nbsp; | &nbsp;
Source code: <a href = "file:../ReadLightToolsSpectrumFile.m"> ReadLightToolsSpectrumFile.m</a>
</p>
</p><p>Reads a spectrum from an ASCII text file in LightTools&reg; spectrum format with comment line handling.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Syntax</a></li><li><a href="#2">Input Arguments</a></li><li><a href="#3">Output Arguments</a></li><li><a href="#4">Algorithm</a></li><li><a href="#5">See also</a></li><li><a href="#6">Usage Example</a></li></ul></div><h2 id="1">Syntax</h2><p><tt>rv = ReadLightToolsSpectrumFile(fn)</tt></p><h2 id="2">Input Arguments</h2><div><ul><li><tt>fn</tt>: character string. Filename from where to read.</li></ul></div><h2 id="3">Output Arguments</h2><div><ul><li><tt>rv</tt>: A valid spectrum (struct with fields <tt>lam</tt> and <tt>val</tt>).</li></ul></div><h2 id="4">Algorithm</h2><p>Reads the lines from the file, assembling the wavelength and value arrays. The 'dataname' entry in the file will make its way into 'dataname' and 'name' fields of the returned spectrum. When the 'discrete' flag is present in the file, the spectrum is approximated as narrow peaks, with 0.001 times the minimum wavelength interval (there are no line spectra in this library). When the 'photometric' flag is set in the file, the returned spectrum is still radiometric, by dividing each value by its corresponding V(lambda) value.</p><h2 id="5">See also</h2><p><a href="ReadASCIITableFile.html">ReadASCIITableSpectrumFile</a>, <a href="ReadASCIITableSpectrumFile.html">ReadASCIITableSpectrumFile</a>, <a href="SpectrumSanityCheck.html">SpectrumSanityCheck</a></p><h2 id="6">Usage Example</h2><pre class="language-matlab">
<span class="keyword">function</span> ExampleReadLightToolsSpectrumFile()
    fn = <span class="string">'LED_2666K.sre'</span>;
    spec = ReadLightToolsSpectrumFile(fn); 
    spec
    figure();
    plot(spec.lam, spec.val);
    xlabel(<span class="string">'\lambda (nm)'</span>);
    title(spec.name);
<span class="keyword">end</span>

</pre><p>publish with publishWithStandardExample('filename.m') in PublishDocumentation.m</p><pre class="codeoutput">
spec = 

  struct with fields:

         lam: [201&times;1 double]
         val: [201&times;1 double]
    dataname: 'OSRAM GW_JCLPS2em, CCT(nominal) = 2700'
        name: 'OSRAM GW_JCLPS2em, CCT(nominal) = 2700'

</pre><img vspace="5" hspace="5" src="ReadLightToolsSpectrumFile_01.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2021a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% ReadLightToolsSpectrumFile
% 
% <html>
%  <p style="font-size:75%;">Navigate to: &nbsp; 
% <a href="JMOSpectrumLibrary.html"> Home</a> &nbsp; | &nbsp;
% <a href="AlphabeticList.html"> Alphabetic list</a> &nbsp; | &nbsp; 
% <a href="GroupedList.html"> Grouped list</a> &nbsp; | &nbsp; 
% Source code: <a href = "file:../ReadLightToolsSpectrumFile.m"> ReadLightToolsSpectrumFile.m</a>
% </p>
% </html>
%
% Reads a spectrum from an ASCII text file in LightTools(R) spectrum format with comment line
% handling.
%% Syntax
% |rv = ReadLightToolsSpectrumFile(fn)|
%% Input Arguments
% * |fn|: character string. Filename from where to read.
%% Output Arguments
% * |rv|: A valid spectrum (struct with fields |lam| and |val|).
%% Algorithm
% Reads the lines from the file, assembling the wavelength and value arrays. The 'dataname'
% entry in the file will make its way into 'dataname' and 'name' fields of the returned
% spectrum. When the 'discrete' flag is present in the file, the spectrum is approximated as
% narrow peaks, with 0.001 times the minimum wavelength interval (there are no line spectra in this library). When the 'photometric' flag
% is set in the file, the returned spectrum is still radiometric, by dividing each value by
% its corresponding V(lambda) value.
%% See also
% <ReadASCIITableFile.html ReadASCIITableSpectrumFile>,
% <ReadASCIITableSpectrumFile.html ReadASCIITableSpectrumFile>,
% <SpectrumSanityCheck.html SpectrumSanityCheck>
%% Usage Example
% <include>Examples/ExampleReadLightToolsSpectrumFile.m</include>
%
% publish with publishWithStandardExample('filename.m') in PublishDocumentation.m

% JMO Spectrum Library, 2021. See https://github.com/JuliusMuschaweck/JMO_Spectrum
% I dedicate the JMO_Spectrum library to the public domain under Creative Commons Zero 
% (https://creativecommons.org/publicdomain/zero/1.0/legalcode)
%
function rv = ReadLightToolsSpectrumFile( fn )
    % Read a spectrum from LightTols .sre file format. Return spectrum, with field "dataname" if present
    %
    % Can also read a simple two column table of numbers, with or without leading string headers
    % If photometric, converts to radiometric
    % if discrete, creates spectrum with narrow peaks (0.001 * minimum lambda interval)
    
    fh = fopen(fn,'r');
    if fh < 0
        error('ReadLightToolsSpectrumFile: file %s not found',fn);
    end
    emptyline = 0;
    dataline = 1;
    commentline = 2;
    stringline = 3;
    line_number = 0;
    dataname = '';
    discrete = false;
    photometric = false;
    [ln, eof, linetype] = Getline();
    % parse header, find dataname if present
    while ~eof && linetype ~= dataline
        if linetype == stringline
            [test, rest] = LineStartsWith(ln,'dataname:');
            if test
                dataname = rest;
            end
            if LineStartsWith(ln, 'discrete')
                discrete = true;
            end
            if LineStartsWith(ln, 'photometric')
                photometric = true;
            end
        end
        [ln, eof, linetype] = Getline();        
    end    
    % parse data
    lam = [];
    val = [];
    while ~eof
        % stop at first empty line, allowing for last line to be empty
        if linetype == emptyline
            break;
        end            
        if linetype ~= dataline
            error('ReadLightToolsSpectrumFile: numeric data expected in line %g, found %s',line_number, ln);
        end
        ilamval = str2num(ln); %#ok<ST2NM>
        if ~isequal(size(ilamval),[1,2])
            error('ReadLightToolsSpectrumFile: two numbers expected in line %g, found %s',line_number, ln);
        end
        lam(end+1) = ilamval(1);  %#ok<AGROW>
        val(end+1) = ilamval(2); %#ok<AGROW>
        [ln, eof, linetype] = Getline();        
    end
    if isempty(lam)
        error('ReadLightToolsSpectrumFile: no data, parsing until line %g',line_number);
    end
    % test for ascending lam
    test = (diff(lam) > 0);
    if ~all(test)
        warning('ReadLightToolsSpectrumFile: wavelengths are not strictly ascending');
        [lam, idx] = sort(lam);
        val = val(idx);
    end
    % test for unique lambdas
    test = (diff(lam) == 0);
    if any(test)
        dbl = lam(test);
        error('ReadLightToolsSpectrumFile: wavelengths are not unique, e.g. %g',dbl(1));
    end
    % convert photometric to radiometric if necessary
    if photometric
       Vlam = Vlambda();
       iVlam = LinInterpol(Vlam.lam, Vlam.val, lam);
       if ~all(iVlam > 0)
           error('ReadLightToolsSpectrumFile: photometric file with some lambda outside 360..830');
       end
       val = val ./ iVlam;
    end
    % make narrow peaks if discrete
    if discrete
        dlam = 0.001 * min(diff(lam));
        % create left and right points. Peaks all have same width, so integrals are ok
        mlam = lam - dlam;
        plam = lam + dlam;
        zeroval = zeros(size(val));
        % exploit column major storage to sort
        ilam = cat(1,mlam,lam,plam);
        ival = cat(1,zeroval, val, zeroval);
        % create row vectors again
        lam = (ilam(:))';
        val = (ival(:))';
    end
    rv.lam = lam(:);
    rv.val = val(:);
    rv.dataname = dataname;
    rv.name = dataname;
    comment = '';
    delim = '';
    if photometric
        comment = 'converted to radiometric from photometric';
        delim = ', ';
    end
    if discrete
        comment = strcat(comment, delim, 'with narrow peaks since spectrum is discrete');
    end
    if ~isempty(comment)
        rv.comment = comment;
    end
    
    function [rv, eof, linetype] = Getline()
        % read line from fh, remove leading whitespace. If at eof, return '' and true
        ln = fgetl(fh);
        line_number = line_number + 1;
        if ischar(ln)
            ln = strrep(ln,char(9),' ');        
            rv = TrimWhitespace(ln);
            eof = false;
        else
            rv = '';
            eof = true;
        end
        if isempty(rv)
            linetype = emptyline;
        elseif rv(1) >= '0' && rv(1) <= '9'
            linetype = dataline;
        elseif rv(1) == '#'
            linetype = commentline;
        else
            linetype = stringline;
        end
    end
    
    function rv = TrimWhitespace(str)
        rv = str;
        while ~isempty(rv) && isspace(rv(1))
            rv = rv(2:end);
        end
    end
    
    function [rv, remainder] = LineStartsWith(str, pattern)
        ix = strfind(str,pattern);
        rv = ~isempty(ix) && ix(1) == 1;
        if rv
            remainder = TrimWhitespace(ln((length(pattern)+1):end));
        else
            remainder = '';
        end
    end
end
##### SOURCE END #####
--></body></html>